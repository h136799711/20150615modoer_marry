define("v3_page/head",["avalon","dialog","lib/avalon/validation","plugins/lazyload","plugins/slideBack"],function(e,f,b){e("avalon");e("dialog");e("lib/avalon/validation");e("plugins/lazyload");e("vMmask");var m=e("plugins/slideBack");this.Love={};Love.tool={pvAnalytis:function(o,p){var q=[];p&&$.each(p,function(s,r){q.push(s+"="+encodeURIComponent(r))});var o=o+"?"+q.join("&");((typeof _hmt)=="undefined")||_hmt.push(["_trackPageview",o])},getCookie:function(q){var r=document.cookie.split("; ");for(var p=0;p<r.length;p++){var o=r[p].split("=");if(o[0]==q){return unescape(o[1])}}},showError:function(p,q){var o=p.nextSibling;while(o&&o.nodeType===3){o=o.nextSibling}if(!(o&&o.className==="us-tips")){o=document.createElement("div");o.className="us-tips";p.parentNode.appendChild(o)}o.innerHTML=q.message},removeError:function(p){var o=p.nextSibling;while(o&&o.nodeType===3){o=o.nextSibling}if(o&&o.className==="us-tips"){p.parentNode.removeChild(o)}},uploadImg:function(o){var p=new plupload.Uploader({runtimes:"html5, flash",browse_button:document.getElementById(o.btndom),container:document.getElementById(o.containerdom),max_file_size:o.size||"5mb",multi_selection:true,url:"/site/ajax/upload_image/",flash_swf_url:"/static/js/plugins/upload.swf",filters:[{title:"Image files",extensions:"jpg,jpeg,gif,png"}],headers:{"X-CSRFToken":$("#csrf").val(),"bucket":o.bucket||"mt-card"}});p.init();p.bind("FilesAdded",function(q,r){o.addCall&&o.addCall(q,r);p.start()});p.bind("UploadProgress",function(q,r){$("#"+r.id+" .progress-bar").width(r.percent+"%").html(r.percent+"%");o.progressCall&&o.progressCall(q,r)});p.bind("Error",function(q,r){o.progressCall&&o.progressCall(q,file)});p.bind("FileUploaded",function(r,u,q){var s=$.parseJSON(q.response);var t=s.data.path;o.uploadedCall&&o.uploadedCall(t)});return p}};if($("img").size()>0){$("img").lazyload({effect:"fadeIn",auto_imgHeight:true,data_attribute:"src"})}var a={};a.validLogin=function(){var o=avalon.define({$id:"login_ctrl",rember:true,postData:{mail:"",pwd:"",rem:1},$skipArray:["validation"],showError:function(q,p){$(q).next().fadeIn().text(p.message)},hideError:function(p){$(p).next().fadeOut().text("")},validation:{onInit:function(p){},onError:function(p){p.forEach(function(q){avalon(this).removeClass("success").addClass("error");o.showError(this,q)},this)},onSuccess:function(){avalon(this).removeClass("error").addClass("success");o.hideError(this)},onValidateAll:function(p){if(avalon.type(p)==="array"){if(p.length===0){n(o.postData.$model,"/u/ajax/sign/")}else{p.forEach(function(q){avalon(q.element).removeClass("success").addClass("error");o.showError(q.element,q)})}}}}});o.$watch("rember",function(p){o.postData.rem=p?1:0;$remember=$("#remember");if(p){$remember.addClass("checked")}else{$remember.removeClass("checked")}});avalon.scan(document.getElementById("login_dialog"),o)};a.validRegis=function(){var o=avalon.define({$id:"regis_ctrl",postData:{email:"",username:"",pwd:"",group_id:"",gender:""},role:"0",$skipArray:["validation"],showError:function(q,p){$(q).next().fadeIn().text(p.message)},hideError:function(p){$(p).next().fadeOut().text("")},showtxt:function(){var p=avalon.vmodels.server_txt;p.toggle=true;avalon.vmodels.Regis.toggle=false;$.get("/u/term/",function(q){p.setContent(q)})},validation:{onInit:function(p){},onError:function(p){p.forEach(function(q){avalon(this).removeClass("success").addClass("error");o.showError(this,q)},this)},onSuccess:function(){avalon(this).removeClass("error").addClass("success");o.hideError(this)},onValidateAll:function(q){if(avalon.type(q)==="array"){if(q.length===0){var p=o.postData.$model;if(p.group_id===3){delete p.gender}n(p,"/u/ajax/join/")}else{q.forEach(function(r){avalon(r.element).removeClass("success").addClass("error");o.showError(r.element,r)})}}}}});o.$watch("role",function(q){var p=o.postData;switch(q){case"m":p.gender="m";p.group_id=1;break;case"f":p.gender="f";p.group_id=1;break;case"su":p.group_id=3;break}});avalon.scan(document.getElementById("regis_dialog"),o)};function n(q,o){var p=document.getElementById("csrf").value;q["csrfmiddlewaretoken"]=p;$.post(o,q,function(r){if(r.status==1001){window.location.reload()}else{alert("登录发生错误，可刷新后重新登录")}},"json")}var d=$("#search-list");if(d.size()>0){var j=d.find(".rote-icon"),h=$("#wrapper"),i=avalon.define({$id:"search_listCtr",cur_val:"灵感",idx:0,show:false,keyword:"",list:[{val:"灵感",url:"/search/tag"},{val:"商家",url:"/search/supplier"},{val:"婚宴",url:"/search/hotel"}],tabShow:function(){i.show=!i.show},tabVal:function(o){i.show=false;i.cur_val=i.list[o].val;i.idx=o},search:function(o){if(o.keyCode==13||o.type=="click"){if($.trim(i.keyword)){window.location.href=i.list[i.idx].url+"?q="+i.keyword}}}});i.$watch("show",function(o){if(o){j.removeClass("rote-icon-d")}else{j.addClass("rote-icon-d")}});avalon.scan(d.get(0),i);if(h.size()>0&&h.data("page")){var g=h.data("page");i.cur_val=g.type;i.idx=parseInt(g.idx,10)}$(document).click(function(o){if(!$(o.target).hasClass("search-tit")&&$(o.target).parents(".search-tit").size()==0){if(i.show){i.show=false}}})}var k=function(){var o=[{uid:6674,name:"LEAF麗芙婚礼"},{uid:20237,name:"广州尚菲丝特高端婚礼策划"}];var p=avalon.define({$id:"vmVipSu",$vipData:o});avalon.scan(document.getElementById("_vmVipSu"),p)};k();var c=function(){this.api={notice_count:"/u/message/unread_notice_count/"};this.init()};c.prototype.init=function(){var o=this.initVm();siteConfig.user&&this.getNotice(o);this.socialLogin()};c.prototype.getNotice=function(p){var o=this;$.getJSON(o.api.notice_count,function(q){if(q.status==1001){p.notice_count=q.data}})};c.prototype.socialLogin=function(){$(".api-third a").click(function(p){var q=$(this),o=q.data("action");window.open(o,"lovewith","height=450,width=750")})};c.prototype.initVm=function(){var o=avalon.define({$id:"vm-header",subnav:false,is_hove:false,notice_count:null,is_login_valid:false,is_regis_valid:false,footer_log:'<div class="oni-dialog-footer">'+'<span ms-click="tab(\'Regis\', \'Login\')" type="dailog" class="fs18">注册</span>'+"</div>",footer_reg:'<div class="oni-dialog-footer">'+'<span ms-click="tab(\'Login\', \'Regis\')" type="dailog" class="fs18">登录</span>'+"</div>",$regOpts:{title:"注册",zIndex:1000,width:476,getFooter:function(){return o.footer_reg}},$server:{title:"婚礼时光网站服务条款及免责声明",width:476,zIndex:1000,onClose:function(){avalon.vmodels.Regis.toggle=true},getFooter:function(){return""}},$logOpts:{title:"登录",zIndex:1000,width:476,getFooter:function(){return o.footer_log}},$inviteOpts:{title:"邀请另一半",zIndex:1000,width:540,getFooter:function(){return""}},show:function(q,p){avalon.vmodels[q].toggle=true;if(!o["is_login"+q]){a["valid"+q]();o["is_login"+q]=true}},tab:function(p,q){avalon.vmodels[p].toggle=true;avalon.vmodels[q].toggle=false;if(!o["is_login"+p]){a["valid"+p]();o["is_login"+p]=true}},dropdownMenu:function(){o.is_hove=true},leaveMenu:function(){o.is_hove=false},openSetting:function(q){var p=avalon.vmodels["vMmask"];p.controll="setting";p.setNav(q);p.showMask();avalon.vmodels["setting"]||e.async(["v3_page/user/setting"],function(s){var r=siteConfig.user.group===3?true:false;s.render({su:r})})}});avalon.scan(document.getElementById("headerVm"),o);return o};new c();var l=function(){this.api={sendInvite:"/u/send/invite/",getInviteKey:"/u/invite_half_key/"};this.vmInviteDialog=avalon.vmodels["vmInviteDialog"];this._is_load=false;this.init();this.csrf=document.getElementById("csrf").value};l.prototype.init=function(){var o=this,p=avalon.define({$id:"vmInviteLove",email:null,phone:null,link:"",code:"",send_email:false,send_phone:false,type:null,checkType:function(q){p.type=q},sendInvite:function(q,r){var s={data:r,type:(q=="email")?2:1,csrfmiddlewaretoken:o.csrf};if(q=="email"){p.send_email=true}else{p.send_phone=true}$.post(o.api.sendInvite,s,function(t){})},$skipArray:["validation"],validation:{onInit:function(q){},onError:function(q){q.forEach(function(r){avalon(this).removeClass("success").addClass("error")},this)},onSuccess:function(){avalon(this).removeClass("error").addClass("success")},onValidateAll:function(q){if(avalon.type(q)==="array"){if(q.length===0){if(p.type=="email"){p.sendInvite("email",p.email)}else{p.sendInvite("phone",p.phone)}}else{q.forEach(function(r){avalon(r.element).removeClass("success").addClass("error")})}}}}});this.bindShowDialog(p)};l.prototype.bindShowDialog=function(p){var o=this;$("#_invite-tip-box").on("click","#_invite-love",function(){o._is_load||$.getJSON(o.api.getInviteKey,function(q){if(q.status==1001){var r=q.data;p.link=siteConfig.host+"u/invite/?inviter="+siteConfig.user.id+"&key="+r.key;p.code=r.captcha;o._is_load=true}});o.vmInviteDialog.toggle=true})};new l();b.exports=a});define("vMmask",[],function(c,b,d){function a(){var e=siteConfig.host;this.side_nav={story_nav_tpl:[{name:"爱情故事",path:"#!/set/shoot",fonts:"&#xe63b;",action:"shoot"}/*,{name:"婚礼视频",path:"#!/set/video",fonts:"&#xe640;",action:"video"}*/],info_nav_tpl:[{name:"个人设置",path:"#!/account/setting",fonts:"&#xe62e;",action:"setting"},{name:"密码设置",path:"#!/account/password",fonts:"&#xe632;",action:"password"},{name:"另一半设置",path:"#!/wed/lover",fonts:"&#xe613;",action:"lover"},{name:"婚期设置",path:"#!/wed/time",fonts:"&#xe62f;",action:"time"},{name:"婚礼地点",path:"#!/wed/address",fonts:"&#xe630;",action:"address"},{name:"婚礼域名",path:"#!/wed/domain",fonts:"&#xe631;",action:"domain"}],suinfo_nav_tpl:[{name:"商家设置",path:"#!/account/setting",fonts:"&#xe62e;",action:"setting"},{name:"商家位置",path:"#!/supplier/address",fonts:"&#xe630;",action:"address"},{name:"密码设置",path:"#!/account/password",fonts:"&#xe632;",action:"password"},{name:"认证",path:e+"su/auth/",fonts:"&#xe62d;",action:""}]};this.mask_tpl='<div id="_mask-body">            <div ms-controller="vMmask" id="vMmask">                <div class="mask-box-side">                    <div class="side-title"><h3 class="color7 fs24">设置</h3></div>                    <ul class="setting-nav fs18">                        <li ms-repeat="side_nav">                            <a ms-class-active="action== el.action" ms-href="el.path" ms-attr-class="el.class">                                <i class="iconfont mr30" ms-html="el.fonts"></i>{{el.name}}</a>                        </li>                    </ul>                </div>                <div class="mask-box-main">                    <div class="mask-close text-right"><a href="javascript:;" ms-click="colseMask"><i class="iconfont">&#xe622;</i></a></div>                    <div id="_mask-main" class="container-fluid"></div>                </div>            </div>        </div>'}a.prototype={init:function(){var e=this,f=avalon.define({$id:"vMmask",action:"story",side_nav:[],controll:"",setNav:function(g){var g=g+"_nav_tpl";f.side_nav=e.side_nav[g]},colseMask:function(){location.hash="";setTimeout(function(){window.location.reload()},800);$("#vMmask .mask-box-main").animate({width:"0",left:"-100%"},350,"swing",function(){$("#_mask-body").hide()});$("#vMmask .mask-box-side").animate({width:"0"},150)},showMask:function(){if($("#_mask-body").size()){$("#_mask-body").show()}else{$("body").append(e.mask_tpl)}var g=document.body.clientWidth,h=16;avalon.scan(document.getElementById("vMmask"),f);if(g<860){h=25}else{if(1200>g&&g>800){h=22}}$(".mask-box-main").animate({width:"100%",left:0,marginRight:-h+"%",paddingLeft:h+"%"},250);$(".mask-box-side").animate({width:h+"%"},1500)}})}};new a().init()});
