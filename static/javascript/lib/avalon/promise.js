define("lib/avalon/promise",["avalon"],function(a,b,c){function d(a,b){if("pending"===a._state)if(a._state="fulfilled",b&&"function"==typeof b.then){var c=b instanceof h?"_then":"then";b[c](function(b){f(a,b)},function(b){a._state="rejected",f(a,b)})}else f(a,b)}function e(a,b){"pending"===a._state&&(a._state="rejected",f(a,b))}function f(a,b){a._fired=!0,a._value=b,i(function(){a._callbacks.forEach(function(b){a._fire(b.onSuccess,b.onFail)})})}function g(a,b){b=Array.isArray(b)?b:[];var c,d=0,e=[];return new h(function(f,g){function h(h,i){h.then(function(g){c||(e[i]=g,d++,(a||d>=b.length)&&(f(a?g:e),c=!0))},function(a){c=!0,g(a)})}for(var i=0,j=b.length;j>i;i++)h(b[i],i);b.length+a===0&&f([])})}a("avalon");var h=function(a){this._callbacks=[];var b=this;if("object"!=typeof this)throw new TypeError("Promises must be constructed via new");if("function"!=typeof a)throw new TypeError("not a function");a(function(a){d(b,a)},function(a){e(b,a)})},i="function"==typeof window.setImmediate?function(a){window.setImmediate(a)}:function(a){window.setTimeout(a,0)};h.resolve=function(a){return new h(function(b){b(a)})},h.reject=function(a){return new h(function(b,c){c(a)})},h.prototype={constructor:h,_state:"pending",_fired:!1,_fire:function(a,b){if("rejected"===this._state){if("function"!=typeof b)throw this._value;b(this._value)}else"function"==typeof a&&a(this._value)},_then:function(a,b){if(this._fired){var c=this;i(function(){c._fire(a,b)})}else this._callbacks.push({onSuccess:a,onFail:b})},then:function(a,b){var c=this;return new h(function(d,e){c._then(function(b){if("function"==typeof a)try{b=a(b)}catch(c){return void e(c)}d(b)},function(a){if("function"==typeof b){try{a=b(a)}catch(c){return void e(c)}d(a)}else e(a)})})},"catch":function(a){return this.then(null,a)},done:function(a){return this.then(a)},fail:function(a){return this.then(null,a)}},h.all=function(a){return g(!1,a)},h.race=function(a){return g(!0,a)};var j=window.Promise;/native code/.test(window.Promise)?(j.prototype.done=h.prototype.done,j.prototype.fail=h.prototype.fail,j.any=j.race):(h.any=h.race,window.Promise=h),avalon.mmPromise=h,c.exports=avalon});